<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FO Tools ‚Äî KMZ Counter & BOQ Calculator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');

:root {
  --bg: #f0f4f8;
  --white: #ffffff;
  --border: #e2e8f0;
  --border2: #cbd5e1;
  --accent: #1e40af;
  --accent-light: #dbeafe;
  --green: #15803d;
  --red: #dc2626;
  --red-light: #fee2e2;
  --yellow: #b45309;
  --orange: #c2410c;
  --orange-light: #ffedd5;
  --text: #0f172a;
  --muted: #64748b;
  --table-head: #1e293b;
  --row-alt: #f8fafc;
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'Plus Jakarta Sans',sans-serif; min-height:100vh; }

/* TOPBAR */
.topbar { background:var(--table-head); color:white; padding:0 2rem; display:flex; align-items:stretch; justify-content:space-between; gap:1rem; position:sticky; top:0; z-index:100; box-shadow:0 2px 8px rgba(0,0,0,0.25); flex-wrap:wrap; }
.topbar-brand { display:flex; align-items:center; gap:0.8rem; padding:0.85rem 0; }
.topbar-brand h1 { font-size:0.95rem; font-weight:700; }
.topbar-brand .sub { font-size:0.7rem; color:#94a3b8; font-family:'JetBrains Mono',monospace; margin-top:2px; }
.tab-nav { display:flex; align-items:stretch; }
.tab-btn { background:none; border:none; color:#94a3b8; padding:0 1.3rem; font-family:'Plus Jakarta Sans',sans-serif; font-size:0.82rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:0.4rem; border-bottom:3px solid transparent; transition:all 0.2s; white-space:nowrap; }
.tab-btn:hover { color:white; background:rgba(255,255,255,0.05); }
.tab-btn.active { color:white; border-bottom-color:#60a5fa; background:rgba(96,165,250,0.08); }
.topbar-actions { display:flex; align-items:center; gap:0.6rem; padding:0.7rem 0; }
.btn-csv { background:var(--accent); color:white; border:none; padding:0.42rem 1rem; border-radius:7px; font-family:'Plus Jakarta Sans',sans-serif; font-weight:600; font-size:0.8rem; cursor:pointer; transition:all 0.2s; }
.btn-csv:hover { background:#1d4ed8; }

/* PAGES */
.page { display:none; }
.page.active { display:block; }

/* ============ KMZ PAGE ============ */
.kmz-wrap { max-width:960px; margin:0 auto; padding:2rem 1.5rem; }

.upload-card { background:white; border:2px dashed var(--border2); border-radius:14px; padding:2.5rem; text-align:center; cursor:pointer; transition:all 0.2s; position:relative; box-shadow:var(--shadow); }
.upload-card:hover,.upload-card.drag { border-color:var(--accent); background:#eff6ff; }
.upload-card input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
.upload-icon { font-size:2.5rem; margin-bottom:0.8rem; }
.upload-card p { color:var(--muted); font-size:0.9rem; line-height:1.7; }
.upload-card strong { color:var(--accent); }

#kmzApp { display:none; }
.kmz-bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:0.8rem; }
.file-badge { display:flex; align-items:center; gap:0.6rem; background:white; border:1px solid var(--border); border-radius:8px; padding:0.5rem 1rem; font-family:'JetBrains Mono',monospace; font-size:0.8rem; box-shadow:var(--shadow); }
.file-badge .fn { color:var(--accent); font-weight:600; }
.file-badge .fs { color:var(--muted); }
.btn-reset { background:none; border:1px solid var(--border); color:var(--muted); padding:0.42rem 1rem; border-radius:8px; cursor:pointer; font-size:0.8rem; transition:all 0.2s; }
.btn-reset:hover { border-color:var(--accent); color:var(--accent); }

.tol-bar { background:white; border:1px solid var(--border); border-radius:10px; padding:0.9rem 1.4rem; margin-bottom:1.5rem; display:flex; align-items:center; gap:1.2rem; flex-wrap:wrap; box-shadow:var(--shadow); }
.tol-bar label { font-size:0.83rem; color:var(--muted); white-space:nowrap; }
.tol-bar input[type=range] { flex:1; min-width:120px; accent-color:var(--accent); }
.tol-val { font-family:'JetBrains Mono',monospace; font-size:0.85rem; color:var(--accent); font-weight:700; min-width:55px; }
.tol-hint { font-size:0.73rem; color:var(--muted); }

/* Import to BOQ banner */
.import-banner { background:linear-gradient(135deg,#1e40af,#1d4ed8); color:white; border-radius:12px; padding:1rem 1.5rem; margin-bottom:1.5rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; box-shadow:0 4px 12px rgba(30,64,175,0.3); }
.import-banner .ib-text strong { display:block; font-size:0.9rem; margin-bottom:0.2rem; }
.import-banner .ib-text span { font-size:0.78rem; color:#bfdbfe; }
.btn-import { background:white; color:var(--accent); border:none; padding:0.5rem 1.3rem; border-radius:8px; font-family:'Plus Jakarta Sans',sans-serif; font-weight:700; font-size:0.82rem; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.btn-import:hover { background:#eff6ff; }

.stat-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:1rem; margin-bottom:1.5rem; }
.s-card { background:white; border:1px solid var(--border); border-radius:12px; padding:1rem 1.2rem; position:relative; overflow:hidden; box-shadow:var(--shadow); }
.s-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.s-card.cr::before { background:var(--accent); }
.s-card.cp::before { background:var(--green); }
.s-card.ch::before { background:#7c3aed; }
.s-card.cu::before { background:var(--red); }
.s-num { font-size:1.9rem; font-weight:800; font-family:'JetBrains Mono',monospace; line-height:1; margin-bottom:0.3rem; }
.s-card.cr .s-num { color:var(--accent); }
.s-card.cp .s-num { color:var(--green); }
.s-card.ch .s-num { color:#7c3aed; }
.s-card.cu .s-num { color:var(--red); }
.s-lbl { font-size:0.7rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.07em; }

.sec-ttl { font-size:0.72rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:var(--muted); display:flex; align-items:center; gap:0.6rem; margin-bottom:0.8rem; }
.sec-ttl::after { content:''; flex:1; height:1px; background:var(--border); }

.kmz-table-wrap { background:white; border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:1.5rem; box-shadow:var(--shadow); overflow-x:auto; }
.kmz-table-wrap table { width:100%; border-collapse:collapse; font-size:0.83rem; }
.kmz-table-wrap thead tr { background:var(--table-head); }
.kmz-table-wrap th { padding:0.7rem 1rem; color:#94a3b8; font-size:0.68rem; text-transform:uppercase; letter-spacing:0.07em; font-weight:600; text-align:left; }
.kmz-table-wrap th.num { text-align:right; }
.kmz-table-wrap tbody tr { border-bottom:1px solid var(--border); transition:background 0.15s; }
.kmz-table-wrap tbody tr:last-child { border-bottom:none; }
.kmz-table-wrap tbody tr:hover { background:#eff6ff; }
.kmz-table-wrap td { padding:0.7rem 1rem; }
.kmz-table-wrap td.num { text-align:right; font-family:'JetBrains Mono',monospace; }
.kmz-table-wrap td.rn { font-family:'JetBrains Mono',monospace; font-size:0.78rem; }
.kmz-table-wrap td.rn span { color:var(--muted); }
.idx-c { color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:0.75rem; }
.v7 { color:var(--green); font-weight:600; }
.v9 { color:var(--yellow); font-weight:600; }
.vh { color:#7c3aed; font-weight:600; }
.bar-cell { padding:0.7rem 1rem; }
.bar-wrap { display:flex; align-items:center; gap:0.6rem; }
.bar { height:8px; border-radius:4px; min-width:3px; }
.bar-lbl { font-family:'JetBrains Mono',monospace; font-size:0.78rem; color:var(--green); min-width:24px; }

.err-box { background:#fee2e2; border:1px solid #fca5a5; border-radius:10px; padding:0.9rem 1.3rem; color:var(--red); font-size:0.85rem; margin-bottom:1.2rem; }
.loading-box { text-align:center; padding:2.5rem; color:var(--muted); font-size:0.85rem; }
.spinner { display:inline-block; width:18px; height:18px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; margin-right:0.5rem; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
.footer-n { font-size:0.73rem; color:var(--muted); text-align:center; padding-top:1rem; font-family:'JetBrains Mono',monospace; border-top:1px solid var(--border); }

/* Route Type Counter */
.rtype-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:1.5rem; }
.rtype-card { background:white; border:1px solid var(--border); border-radius:12px; padding:1rem 1.3rem; box-shadow:var(--shadow); position:relative; overflow:hidden; }
.rtype-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; }
.rtype-card.rt-nc::before { background:#1e40af; }
.rtype-card.rt-cc::before { background:#7c3aed; }
.rtype-card.rt-cp::before { background:#15803d; }
.rtype-num { font-size:1.6rem; font-weight:800; font-family:'JetBrains Mono',monospace; line-height:1; }
.rtype-card.rt-nc .rtype-num { color:#1e40af; }
.rtype-card.rt-cc .rtype-num { color:#7c3aed; }
.rtype-card.rt-cp .rtype-num { color:#15803d; }
.rtype-sub { font-size:0.72rem; color:var(--muted); font-family:'JetBrains Mono',monospace; margin-top:0.25rem; }
.rtype-lbl { font-size:0.68rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--muted); margin-bottom:0.4rem; }
.rtype-seg { font-size:0.7rem; color:var(--muted); margin-top:0.3rem; }
.rtype-pill { display:inline-block; font-size:0.6rem; font-weight:700; padding:0.1rem 0.45rem; border-radius:20px; margin-top:0.35rem; }
.rt-nc .rtype-pill { background:#dbeafe; color:#1e40af; }
.rt-cc .rtype-pill { background:#ede9fe; color:#7c3aed; }
.rt-cp .rtype-pill { background:#dcfce7; color:#15803d; }

/* ============ BOQ PAGE ============ */
main.boq { max-width:1200px; margin:2rem auto; padding:0 1.5rem; display:flex; flex-direction:column; gap:1.5rem; }

/* Import source badge */
.import-source { background:#eff6ff; border:1px solid #bfdbfe; border-radius:10px; padding:0.75rem 1.2rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.8rem; }
.import-source .is-info { font-size:0.82rem; color:var(--accent); display:flex; align-items:center; gap:0.5rem; }
.import-source .is-info strong { font-weight:700; }
.btn-clear-import { background:none; border:1px solid #93c5fd; color:#1e40af; padding:0.32rem 0.8rem; border-radius:6px; font-size:0.75rem; font-weight:600; cursor:pointer; transition:all 0.2s; }
.btn-clear-import:hover { background:#dbeafe; }

.proj-card { background:white; border:1px solid var(--border); border-radius:14px; padding:1.2rem 1.5rem; box-shadow:var(--shadow); display:flex; align-items:center; gap:1.5rem; flex-wrap:wrap; }
.proj-lbl { font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.3rem; }
.proj-val { font-size:0.95rem; font-weight:700; }
.proj-input { border:1px solid var(--border2); border-radius:7px; padding:0.45rem 0.8rem; font-family:'Plus Jakarta Sans',sans-serif; font-size:0.9rem; font-weight:600; background:#f8fafc; outline:none; transition:border 0.2s; min-width:220px; }
.proj-input:focus { border-color:var(--accent); background:white; }
.vat-input { border:1px solid var(--border2); border-radius:7px; padding:0.45rem 0.6rem; font-family:'JetBrains Mono',monospace; font-size:0.9rem; font-weight:600; outline:none; width:60px; text-align:right; }
.vat-input:focus { border-color:var(--accent); }
.bq-div { width:1px; height:40px; background:var(--border); }

.sum-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; }
.sum-card { background:white; border:1px solid var(--border); border-radius:12px; padding:1.1rem 1.3rem; box-shadow:var(--shadow); position:relative; overflow:hidden; }
.sum-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; border-radius:12px 0 0 12px; }
.sum-card.sc-sub::before { background:var(--accent); }
.sum-card.sc-vat::before { background:var(--yellow); }
.sum-card.sc-tot::before { background:var(--green); }
.sum-card.sc-vol::before { background:#7c3aed; }
.sc-lbl { font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.5rem; }
.sc-val { font-size:1.4rem; font-weight:800; font-family:'JetBrains Mono',monospace; line-height:1.1; }
.sum-card.sc-sub .sc-val { color:var(--accent); }
.sum-card.sc-vat .sc-val { color:var(--yellow); }
.sum-card.sc-tot .sc-val { color:var(--green); }
.sum-card.sc-vol .sc-val { color:#7c3aed; }
.sc-sub2 { font-size:0.7rem; color:var(--muted); margin-top:0.3rem; font-family:'JetBrains Mono',monospace; }

.bq-sec { font-size:0.72rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:var(--muted); display:flex; align-items:center; gap:0.6rem; }
.bq-sec::after { content:''; flex:1; height:1px; background:var(--border); }

.formula-box { background:#fffbeb; border:1px solid #fde68a; border-radius:10px; padding:0.9rem 1.2rem; font-size:0.8rem; color:#92400e; display:flex; align-items:flex-start; gap:0.7rem; flex-wrap:wrap; }
.formula-box strong { display:block; margin-bottom:0.3rem; font-size:0.82rem; color:#78350f; }
.ftag { display:inline-block; background:#fef3c7; border:1px solid #fcd34d; border-radius:5px; padding:0.15rem 0.5rem; font-family:'JetBrains Mono',monospace; font-size:0.75rem; margin:0.1rem 0.15rem 0.1rem 0; color:#92400e; }

.rm-card { background:white; border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:var(--shadow); }
.rm-head { background:#f8fafc; border-bottom:1px solid var(--border); padding:0.9rem 1.3rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.8rem; }
.rm-title { font-size:0.85rem; font-weight:700; }
.btn-add { background:var(--accent-light,#dbeafe); color:var(--accent); border:none; padding:0.4rem 0.9rem; border-radius:6px; font-family:'Plus Jakarta Sans',sans-serif; font-size:0.78rem; font-weight:600; cursor:pointer; transition:all 0.2s; }
.btn-add:hover { background:var(--accent); color:white; }

.rt-wrap { overflow-x:auto; }
table.rt { width:100%; border-collapse:collapse; font-size:0.82rem; }
table.rt thead tr { background:var(--table-head); }
table.rt th { padding:0.7rem 0.8rem; color:#94a3b8; font-size:0.68rem; text-transform:uppercase; letter-spacing:0.07em; font-weight:600; text-align:left; white-space:nowrap; }
table.rt th.r { text-align:right; }
table.rt th.c { text-align:center; }
table.rt th.gi { color:#7dd3fc; border-bottom:2px solid #3b82f6; }
table.rt th.gc { color:#86efac; border-bottom:2px solid #22c55e; }
table.rt th.go { color:#fca5a5; border-bottom:2px solid #ef4444; }
table.rt tbody tr { border-bottom:1px solid var(--border); }
table.rt tbody tr:last-child { border-bottom:none; }
table.rt tbody tr:nth-child(even) { background:var(--row-alt); }
table.rt tbody tr:hover { background:#eff6ff; }
table.rt td { padding:0.6rem 0.8rem; vertical-align:middle; }
table.rt td.r { text-align:right; font-family:'JetBrains Mono',monospace; }
table.rt td.c { text-align:center; }
table.rt td.mc { color:var(--muted); font-size:0.75rem; }
.cs1 { border-left:2px solid #3b82f6 !important; }
.cs2 { border-left:2px solid #22c55e !important; }
.cs3 { border-left:2px solid #ef4444 !important; }
.cs4 { border-left:2px solid #f59e0b !important; }
table.rt th.gr { color:#fcd34d; border-bottom:2px solid #f59e0b; }
.td-calc-ring { font-family:'JetBrains Mono',monospace; font-size:0.8rem; color:#b45309; font-weight:700; background:#fffbeb; border:1px solid #fcd34d; border-radius:6px; padding:0.32rem 0.55rem; min-width:72px; text-align:right; display:inline-block; width:100%; }
.td-in-dim { border:1px solid var(--border); border-radius:6px; padding:0.32rem 0.55rem; width:100%; min-width:72px; font-family:'JetBrains Mono',monospace; font-size:0.8rem; text-align:right; outline:none; background:#f8fafc; color:var(--muted); opacity:0.4; pointer-events:none; }
table.rt tbody tr.ring-row { background:#fffbeb !important; }
table.rt tbody tr.ring-row:hover { background:#fef3c7 !important; }
.ring-chk { width:15px; height:15px; accent-color:#f59e0b; cursor:pointer; }
.badge-ring { display:inline-block; font-size:0.6rem; font-weight:700; padding:0.1rem 0.4rem; border-radius:4px; background:#fef3c7; color:#92400e; text-transform:uppercase; margin-left:0.3rem; vertical-align:middle; border:1px solid #fcd34d; }

/* imported row highlight */
table.rt tbody tr.from-kmz { background:#f0fdf4 !important; }
table.rt tbody tr.from-kmz:hover { background:#dcfce7 !important; }

.td-in { border:1px solid var(--border); border-radius:6px; padding:0.32rem 0.55rem; width:100%; min-width:72px; font-family:'JetBrains Mono',monospace; font-size:0.8rem; text-align:right; outline:none; transition:border 0.2s; background:white; }
.td-in:focus { border-color:var(--accent); box-shadow:0 0 0 2px rgba(30,64,175,0.08); }
.td-name { border:1px solid var(--border); border-radius:6px; padding:0.32rem 0.55rem; width:100%; min-width:130px; font-family:'Plus Jakarta Sans',sans-serif; font-size:0.8rem; outline:none; transition:border 0.2s; background:white; }
.td-name:focus { border-color:var(--accent); }
.td-calc { font-family:'JetBrains Mono',monospace; font-size:0.8rem; color:var(--green); font-weight:700; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:6px; padding:0.32rem 0.55rem; min-width:72px; text-align:right; display:inline-block; width:100%; }
.td-calc-d { font-size:0.63rem; color:var(--muted); margin-top:2px; font-family:'JetBrains Mono',monospace; }
.btn-del { background:var(--red-light,#fee2e2); color:var(--red); border:none; width:26px; height:26px; border-radius:6px; cursor:pointer; font-size:0.85rem; transition:all 0.2s; }
.btn-del:hover { background:var(--red); color:white; }

.boq-card { background:white; border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:var(--shadow); }
.boq-hd { background:var(--table-head); padding:0.9rem 1.3rem; display:flex; align-items:center; justify-content:space-between; }
.boq-hd-ttl { color:white; font-size:0.85rem; font-weight:700; }
.chip { font-size:0.68rem; font-weight:700; padding:0.2rem 0.6rem; border-radius:20px; background:rgba(255,255,255,0.1); color:#fbbf24; }
tr.row-sub td { background:#f0f7ff; font-weight:700; border-top:2px solid var(--border2); }
tr.row-vat td { background:#fffbeb; font-weight:600; color:var(--yellow); }
tr.row-tot td { background:#f0fdf4; font-weight:800; color:var(--green); font-size:0.9rem; }
.computed { color:var(--accent); font-weight:600; }
.computed-t { color:var(--green); font-weight:700; }
.it-desc { font-weight:500; line-height:1.4; }
.it-desc small { display:block; color:var(--muted); font-size:0.72rem; font-weight:400; }
.badge-f { display:inline-block; font-size:0.6rem; font-weight:700; padding:0.1rem 0.4rem; border-radius:4px; background:var(--orange-light,#ffedd5); color:var(--orange); text-transform:uppercase; margin-left:0.3rem; vertical-align:middle; }
.badge-k { display:inline-block; font-size:0.6rem; font-weight:700; padding:0.1rem 0.4rem; border-radius:4px; background:#dcfce7; color:var(--green); text-transform:uppercase; margin-left:0.3rem; vertical-align:middle; }

@media(max-width:600px){
  .topbar { padding:0 1rem; }
  .tab-btn { padding:0 0.7rem; font-size:0.75rem; }
  main.boq { padding:0 0.8rem; margin-top:1.5rem; }
  .kmz-wrap { padding:1.5rem 0.8rem; }
  .sum-grid { grid-template-columns:1fr 1fr; }
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-brand">
    <span style="font-size:1.3rem">üîå</span>
    <div>
      <h1>FO Tools</h1>
      <div class="sub">Fiber Optic Infrastructure Toolkit</div>
    </div>
  </div>
  <div style="display:flex;align-items:stretch">
    <div class="tab-nav">
      <button class="tab-btn active" id="tab-kmz" onclick="switchTab('kmz')">üó∫Ô∏è KMZ Counter</button>
      <button class="tab-btn" id="tab-boq" onclick="switchTab('boq')">üìã BOQ Calculator</button>
    </div>
    <div class="topbar-actions" id="boqActions" style="display:none">
      <div style="width:1px;height:28px;background:rgba(255,255,255,0.15);margin:0 0.3rem"></div>
      <button class="btn-csv" onclick="exportCSV()">‚¨á CSV</button>
    </div>
  </div>
</div>


<!-- ======================================================= -->
<!-- PAGE: KMZ COUNTER                                       -->
<!-- ======================================================= -->
<div class="page active" id="page-kmz">
<div class="kmz-wrap">

  <div class="upload-card" id="dropZone">
    <input type="file" id="fileInput" accept=".kmz,.kml">
    <div class="upload-icon">üì¶</div>
    <p><strong>Drop file .KMZ atau .KML di sini</strong><br>atau klik untuk memilih file</p>
  </div>

  <div id="kmzApp">
    <div class="kmz-bar">
      <div class="file-badge">
        <span>üì¶</span>
        <span class="fn" id="fileName">-</span>
        <span class="fs" id="fileSize">-</span>
      </div>
      <button class="btn-reset" onclick="resetKmz()">‚Ü© Ganti File</button>
    </div>

    <div class="tol-bar">
      <label>üéØ Toleransi jarak pole ke route:</label>
      <input type="range" id="tolSlider" min="5" max="200" value="30" step="5" oninput="onTolChange(this.value)">
      <span class="tol-val" id="tolVal">30 m</span>
      <span class="tol-hint">‚Äî Perkecil untuk lebih presisi, perbesar jika pole tidak terhitung</span>
    </div>

    <div id="errBox" class="err-box" style="display:none"></div>
    <div id="loadBox" class="loading-box" style="display:none"><span class="spinner"></span> Menghitung...</div>

    <div id="kmzContent" style="display:none">

      <!-- Import banner -->
      <div class="import-banner">
        <div class="ib-text">
          <strong>üì• Import ke BOQ Calculator</strong>
          <span>Nama route, panjang kabel, hanger, dan tiang akan otomatis diisi ‚Äî semua masih bisa diedit manual.</span>
        </div>
        <button class="btn-import" onclick="importToBoq()">Import ke BOQ ‚Üí</button>
      </div>

      <div class="stat-grid">
        <div class="s-card cr"><div class="s-num" id="statR">-</div><div class="s-lbl">Segmen Route</div></div>
        <div class="s-card cp"><div class="s-num" id="statP">-</div><div class="s-lbl">Total Tiang Baru</div></div>
        <div class="s-card" style="border-top:none;position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:#f59e0b"></div><div class="s-num" id="statTE" style="color:#b45309">-</div><div class="s-lbl">Total Tiang Existing (TE)</div></div>
        <div class="s-card ch"><div class="s-num" id="statH">-</div><div class="s-lbl">Total Hanger</div></div>
        <div class="s-card cu"><div class="s-num" id="statU">-</div><div class="s-lbl">Pole Tak Terdeteksi</div></div>
      </div>

      <div class="sec-ttl">Panjang Route per Tipe Kabel</div>
      <div class="rtype-grid">
        <div class="rtype-card rt-nc">
          <div class="rtype-lbl">üîµ New Cable</div>
          <div class="rtype-num" id="rtLenNC">0</div>
          <div class="rtype-sub" id="rtSubNC">0 m total</div>
          <div class="rtype-seg" id="rtSegNC">0 segmen</div>
          <span class="rtype-pill">Kabel Baru</span>
        </div>
        <div class="rtype-card rt-cc">
          <div class="rtype-lbl">üü£ Collo Cable</div>
          <div class="rtype-num" id="rtLenCC">0</div>
          <div class="rtype-sub" id="rtSubCC">0 m total</div>
          <div class="rtype-seg" id="rtSegCC">0 segmen</div>
          <span class="rtype-pill">Collo Cable</span>
        </div>
        <div class="rtype-card rt-cp">
          <div class="rtype-lbl">üü¢ Collo Pole</div>
          <div class="rtype-num" id="rtLenCP">0</div>
          <div class="rtype-sub" id="rtSubCP">0 m total</div>
          <div class="rtype-seg" id="rtSegCP">0 segmen</div>
          <span class="rtype-pill">Collo Pole</span>
        </div>
      </div>

      <div class="sec-ttl">Detail Per Segmen Route</div>
      <div class="kmz-table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Segmen Route</th>
              <th class="num">Tipe</th>
              <th class="num">Panjang (m)</th>
              <th class="num">Pole 7</th>
              <th class="num">Pole 9</th>
              <th class="num" style="color:#fcd34d">TE (Existing)</th>
              <th class="num">Hanger</th>
            </tr>
          </thead>
          <tbody id="kmzTbody"></tbody>
        </table>
      </div>

      <div class="footer-n" id="footerN"></div>
    </div>
  </div>

</div>
</div>


<!-- ======================================================= -->
<!-- PAGE: BOQ CALCULATOR                                    -->
<!-- ======================================================= -->
<div class="page" id="page-boq">
<main class="boq">

  <!-- Import source badge (hidden until import) -->
  <div class="import-source" id="importBadge" style="display:none">
    <div class="is-info">
      <span>üì¶</span>
      <span>Data diimport dari: <strong id="importSrcName">-</strong></span>
    </div>
    <button class="btn-clear-import" onclick="clearImport()">‚úï Hapus import, isi manual</button>
  </div>

  <!-- PROJECT INFO -->
  <div class="proj-card">
    <div>
      <div class="proj-lbl">Nama Pekerjaan</div>
      <input class="proj-input" id="projName" value="IF-TBL-MOCNPhase2-DF070" placeholder="Nama proyek...">
    </div>
    <div class="bq-div"></div>
    <div>
      <div class="proj-lbl">VAT (%)</div>
      <input class="vat-input" id="vatPct" value="11" type="text" inputmode="numeric" oninput="recalc()"> %
    </div>
    <div class="bq-div"></div>
    <div>
      <div class="proj-lbl">Total Segmen</div>
      <div class="proj-val" id="infoRoutes">‚Äî</div>
    </div>
  </div>

  <!-- FORMULA -->
  <div class="formula-box">
    <span style="font-size:1.1rem;flex-shrink:0;margin-top:1px">üìê</span>
    <div>
      <strong>Rumus Panjang Akhir Kabel (otomatis)</strong>
      <span class="ftag">(Panjang Kabel √ó 1.1)</span> +
      <span class="ftag">(Hanger √ó 20)</span> =
      <span class="ftag" style="background:#dcfce7;border-color:#86efac;color:#15803d">Panjang Akhir ‚Üí Volume BOQ</span>
      <div style="margin-top:0.4rem;font-size:0.74rem;color:#78350f">
        Berlaku untuk: New Cable ¬∑ Collo ‚â§24 ¬∑ Collo Cable. &nbsp;
        Kolom <span style="color:#3b82f6;font-weight:700">biru</span> = input raw (m), kolom <span style="color:#22c55e;font-weight:700">hijau</span> = kalkulasi otomatis.
      </div>
    </div>
    <div style="border-left:2px solid #fcd34d;padding-left:0.9rem">
      <strong>‚ü≥ Ring Logic ‚Äî Tiang Baru Dilewati 2√ó</strong>
      <span class="ftag" style="background:#fef3c7;border-color:#fcd34d;color:#92400e">TB7/TB9 ring + TE ‚Üí masuk Collo ‚â§24</span>
      <div style="margin-top:0.4rem;font-size:0.74rem;color:#78350f">
        Centang <span style="color:#f59e0b;font-weight:700">‚ü≥</span> per route ‚Üí isi TB ring / TE ‚Üí otomatis ditambahkan ke volume Collo ‚â§24. Import KMZ ‚Üí TE otomatis terisi.
      </div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="sum-grid">
    <div class="sum-card sc-sub"><div class="sc-lbl">Subtotal</div><div class="sc-val" id="sumSub">Rp 0</div><div class="sc-sub2" id="sumSubF">0</div></div>
    <div class="sum-card sc-vat"><div class="sc-lbl">VAT <span id="vatLbl">11%</span></div><div class="sc-val" id="sumVat">Rp 0</div><div class="sc-sub2" id="sumVatF">0</div></div>
    <div class="sum-card sc-tot"><div class="sc-lbl">Total Akhir</div><div class="sc-val" id="sumTot">Rp 0</div><div class="sc-sub2" id="sumTotF">0</div></div>
    <div class="sum-card sc-vol"><div class="sc-lbl">Total Volume</div><div class="sc-val" id="sumVol">0</div><div class="sc-sub2">unit keseluruhan</div></div>
  </div>

  <!-- ROUTE TABLE -->
  <div class="bq-sec">Segmen Route & Input Volume</div>
  <div class="rm-card">
    <div class="rm-head">
      <span class="rm-title">üìç Daftar Route / Segmen</span>
      <button class="btn-add" onclick="addRoute()">Ôºã Tambah Route</button>
    </div>
    <div class="rt-wrap">
      <table class="rt">
        <thead>
          <tr>
            <th rowspan="2">#</th>
            <th rowspan="2">Nama Route</th>
            <th colspan="5" class="gi" style="text-align:center;border-bottom:none">‚ñ∂ INPUT PANJANG KABEL (m) & JUMLAH</th>
            <th colspan="3" class="gc" style="text-align:center;border-bottom:none">‚öô PANJANG AKHIR OTOMATIS (m)</th>
            <th colspan="2" class="go" style="text-align:center;border-bottom:none">Tiang & Hanger</th>
            <th colspan="5" class="gr" style="text-align:center;border-bottom:none">‚ü≥ RING LOGIC (Tiang 2√ó)</th>
            <th rowspan="2" class="c">Del</th>
          </tr>
          <tr>
            <th class="r gi cs1">New Cable (m)</th>
            <th class="r gi">Collo ‚â§24 (m)</th>
            <th class="r gi">Collo Cable (m)</th>
            <th class="r gi">Hanger (unit)</th>
            <th class="r gi">Slack/Extra</th>
            <th class="r gc cs2">New Cable Akhir</th>
            <th class="r gc">Collo ‚â§24 Akhir</th>
            <th class="r gc">Collo Cable Akhir</th>
            <th class="r go cs3">Pole 7m</th>
            <th class="r go">Pole 9m</th>
            <th class="c gr cs4" title="Aktifkan Ring Logic">‚ü≥</th>
            <th class="r gr">TB7 ring</th>
            <th class="r gr">TB9 ring</th>
            <th class="r gr">TE (Collo Pole)</th>
            <th class="r gr">‚Üí Collo ‚â§24</th>
          </tr>
        </thead>
        <tbody id="routeBody"></tbody>
      </table>
    </div>
  </div>

  <!-- BOQ TABLE -->
  <div class="bq-sec">Bill of Quantity</div>
  <div class="boq-card">
    <div class="boq-hd">
      <span class="boq-hd-ttl">üìä Rincian BOQ</span>
      <span class="chip">VAT <span id="vatChip">11</span>%</span>
    </div>
    <div class="rt-wrap">
      <table class="rt">
        <thead>
          <tr>
            <th>No</th><th>Uraian Pekerjaan</th>
            <th class="r">Unit Price (Rp)</th>
            <th class="r" id="colA">Route 1</th>
            <th class="r" id="colB">Route 2</th>
            <th class="r">Total Volume</th>
            <th class="r">Total Amount (Rp)</th>
          </tr>
        </thead>
        <tbody id="boqBody"></tbody>
      </table>
    </div>
  </div>

</main>
</div>


<!-- ======================================================= -->
<!-- SCRIPTS                                                 -->
<!-- ======================================================= -->
<script>

// ‚îÄ‚îÄ‚îÄ TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(t) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  document.getElementById('tab-'+t).classList.add('active');
  document.getElementById('boqActions').style.display = t==='boq' ? 'flex' : 'none';
}

// ‚îÄ‚îÄ‚îÄ KMZ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let kmzData = null;          // raw parsed data
let kmzResults = null;       // computed { routes, p7counts, p9counts, hgcounts, lengths }
let curTol = 30;

const dropZone  = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const kmzApp    = document.getElementById('kmzApp');

dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
dropZone.addEventListener('drop',      e => { e.preventDefault(); dropZone.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change',   e => handleFile(e.target.files[0]));

async function handleFile(file) {
  if (!file) return;
  showLoad(true);
  document.getElementById('kmzContent').style.display = 'none';
  document.getElementById('errBox').style.display = 'none';

  try {
    let kmlText;
    if (file.name.toLowerCase().endsWith('.kmz')) {
      const zip = await JSZip.loadAsync(file);
      const kf  = Object.values(zip.files).find(f => f.name.endsWith('.kml'));
      if (!kf) throw new Error('Tidak ada file KML di dalam KMZ.');
      kmlText = await kf.async('string');
    } else {
      kmlText = await file.text();
    }

    kmlText = kmlText.replace(/<(\w+:)/g,'<').replace(/<\/(\w+:)/g,'</');
    kmlText = kmlText.replace(/\s+xmlns(?::\w+)?="[^"]*"/g,'');
    kmlText = kmlText.replace(/\s+\w+:\w+="[^"]*"/g,'');

    const xml = new DOMParser().parseFromString(kmlText,'text/xml');
    if (xml.querySelector('parsererror')) throw new Error('File KML tidak valid.');

    kmzData = parseKml(xml);
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = (file.size/1024).toFixed(1)+' KB';
    kmzApp.style.display = 'block';
    dropZone.style.display = 'none';
    showLoad(false);
    renderKmz(kmzData, curTol);
  } catch(err) {
    showLoad(false);
    kmzApp.style.display = 'block';
    dropZone.style.display = 'none';
    showErr(err.message);
  }
}

function showLoad(v) { document.getElementById('loadBox').style.display = v?'block':'none'; }
function showErr(m)  { const el=document.getElementById('errBox'); el.textContent='‚ùå '+m; el.style.display='block'; }

function kmlName(el) {
  for (const t of ['name','n']) {
    const c = el.querySelector(':scope > '+t);
    if (c && c.textContent.trim()) return c.textContent.trim();
  }
  return '';
}

function parseKml(xml) {
  const data = { routes:[], poles:{p7:[],p9:[],te:[]}, hangers:[] };

  function findFolder(root, kw) {
    for (const f of root.querySelectorAll('Folder'))
      if (kmlName(f).toLowerCase().includes(kw.toLowerCase())) return f;
    return null;
  }
  function parseCoord(s) {
    const p = s.trim().split(',');
    return p.length >= 2 ? [parseFloat(p[0]),parseFloat(p[1])] : null;
  }

  // Routes from New Cable, Colo Cable, Colo Pole (LineString)
  function collectRoutes(folder, type) {
    if (!folder) return;
    for (const pm of folder.querySelectorAll(':scope > Placemark')) {
      const ls = pm.querySelector('LineString');
      const ce = ls ? ls.querySelector('coordinates') : pm.querySelector('coordinates');
      if (ce) {
        const pts = ce.textContent.trim().split(/\s+/).map(parseCoord).filter(Boolean);
        if (pts.length > 1) data.routes.push({ name: kmlName(pm), points: pts, type: type });
      }
    }
  }
  collectRoutes(findFolder(xml,'New Cable'), 'new_cable');
  collectRoutes(findFolder(xml,'Colo Cable'), 'collo_cable');
  collectRoutes(findFolder(xml,'Colo Pole'), 'collo_pole');
  if (data.routes.length === 0) {
    for (const pm of xml.querySelectorAll('Placemark')) {
      const ls = pm.querySelector('LineString');
      if (ls) {
        const ce = ls.querySelector('coordinates');
        if (ce) {
          const pts = ce.textContent.trim().split(/\s+/).map(parseCoord).filter(Boolean);
          if (pts.length > 1) data.routes.push({ name: kmlName(pm)||'Route', points: pts, type: 'unknown' });
        }
      }
    }
  }

  function collectPts(folder) {
    const res = [];
    if (!folder) return res;
    for (const pm of folder.querySelectorAll('Placemark')) {
      const ce = pm.querySelector('coordinates');
      if (ce) ce.textContent.trim().split(/\s+/).map(parseCoord).filter(Boolean).forEach(p => res.push(p));
    }
    return res;
  }
  data.poles.p7 = collectPts(findFolder(xml,'Pole 7'));
  data.poles.p9 = collectPts(findFolder(xml,'Pole 9'));
  data.poles.te = collectPts(findFolder(xml,'Existing Pole'));
  data.hangers  = collectPts(findFolder(xml,'Hanger'));
  return data;
}

// ‚îÄ‚îÄ‚îÄ SPATIAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const D2M = 111320;
function segDist(px,py,ax,ay,bx,by) {
  const dx=bx-ax, dy=by-ay;
  if (!dx&&!dy) return Math.hypot(px-ax,py-ay);
  let t=((px-ax)*dx+(py-ay)*dy)/(dx*dx+dy*dy);
  t=Math.max(0,Math.min(1,t));
  return Math.hypot(px-(ax+t*dx),py-(ay+t*dy));
}
function polyDist(pt,poly) {
  let min=Infinity;
  for (let i=0;i<poly.length-1;i++) {
    const d=segDist(pt[0],pt[1],poly[i][0],poly[i][1],poly[i+1][0],poly[i+1][1]);
    if(d<min) min=d;
  }
  return min*D2M;
}
function polyLen(pts) {
  // Haversine-lite: length in meters
  let len=0;
  for(let i=0;i<pts.length-1;i++){
    const dx=(pts[i+1][0]-pts[i][0])*D2M*Math.cos(pts[i][1]*Math.PI/180);
    const dy=(pts[i+1][1]-pts[i][1])*D2M;
    len+=Math.hypot(dx,dy);
  }
  return Math.round(len);
}
function assign(pts,routes,tol) {
  const counts=routes.map(()=>0); let unm=0;
  for(const pt of pts){
    let bd=Infinity,bi=-1;
    for(let i=0;i<routes.length;i++){const d=polyDist(pt,routes[i].points);if(d<bd){bd=d;bi=i;}}
    if(bi>=0&&bd<=tol) counts[bi]++; else unm++;
  }
  return {counts,unm};
}

// ‚îÄ‚îÄ‚îÄ KMZ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderKmz(data, tol) {
  document.getElementById('loadBox').style.display='block';
  document.getElementById('kmzContent').style.display='none';
  setTimeout(()=>{
    try {
      const {routes,poles,hangers}=data;
      const p7=assign(poles.p7,routes,tol);
      const p9=assign(poles.p9,routes,tol);
      const te=assign(poles.te||[],routes,tol);
      const hg=assign(hangers,routes,tol);

      // Store computed results for import
      kmzResults = {
        routes: routes,
        p7counts: p7.counts, p9counts: p9.counts, tecounts: te.counts, hgcounts: hg.counts,
        lengths: routes.map(r=>polyLen(r.points)),
        unmatched: p7.unm+p9.unm+te.unm
      };

      document.getElementById('statR').textContent = routes.length;
      document.getElementById('statP').textContent = poles.p7.length+poles.p9.length;
      document.getElementById('statTE').textContent = (poles.te||[]).length;
      document.getElementById('statH').textContent = hangers.length;
      document.getElementById('statU').textContent = p7.unm+p9.unm+te.unm;

      const tbody = document.getElementById('kmzTbody');
      tbody.innerHTML='';
      let gp7=0,gp9=0,gte=0,ghg=0,glen=0;
      const typeStats = { new_cable:{len:0,seg:0}, collo_cable:{len:0,seg:0}, collo_pole:{len:0,seg:0}, unknown:{len:0,seg:0} };

      const typeMeta = {
        new_cable:   { label:'New Cable',   color:'var(--accent)',  bg:'#dbeafe', pill:'üîµ' },
        collo_cable: { label:'Collo Cable', color:'#7c3aed',        bg:'#ede9fe', pill:'üü£' },
        collo_pole:  { label:'Collo Pole',  color:'var(--green)',   bg:'#dcfce7', pill:'üü¢' },
        unknown:     { label:'‚Äî',           color:'var(--muted)',   bg:'#f1f5f9', pill:'‚ö™' },
      };

      routes.forEach((r,i)=>{
        const c7=p7.counts[i], c9=p9.counts[i], ct=te.counts[i], ch=hg.counts[i];
        gp7+=c7; gp9+=c9; gte+=ct; ghg+=ch;
        const len=kmzResults.lengths[i]; glen+=len;
        const rtype = r.type||'unknown';
        if(typeStats[rtype]){ typeStats[rtype].len+=len; typeStats[rtype].seg++; }
        const meta = typeMeta[rtype]||typeMeta.unknown;
        const [fr,to]=r.name.split(';');
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="idx-c">${i+1}</td>
          <td class="rn">${fr||r.name}<br><span>‚Üí ${to||''}</span></td>
          <td class="num"><span style="display:inline-block;font-size:0.7rem;font-weight:700;padding:0.15rem 0.55rem;border-radius:20px;background:${meta.bg};color:${meta.color}">${meta.pill} ${meta.label}</span></td>
          <td class="num" style="color:var(--accent);font-weight:600">${len.toLocaleString('id-ID')}</td>
          <td class="num v7">${c7}</td>
          <td class="num v9">${c9}</td>
          <td class="num" style="color:#b45309;font-weight:600">${ct}</td>
          <td class="num vh">${ch}</td>`;
        tbody.appendChild(tr);
      });

      const trT=document.createElement('tr');
      trT.style.cssText='background:#f0f7ff;font-weight:700;border-top:2px solid var(--border2)';
      trT.innerHTML=`<td class="idx-c">‚Äî</td><td style="font-weight:800">TOTAL</td>
        <td></td>
        <td class="num" style="color:var(--accent);font-weight:700">${glen.toLocaleString('id-ID')}</td>
        <td class="num v7">${gp7}</td>
        <td class="num v9">${gp9}</td>
        <td class="num" style="color:#b45309;font-weight:700">${gte}</td>
        <td class="num vh">${ghg}</td>`;

      // Update route-type counter cards
      function fmtLen(n){ return n>=1000?(n/1000).toFixed(2)+' km':n.toLocaleString('id-ID')+' m'; }
      const nc=typeStats.new_cable, cc=typeStats.collo_cable, cp=typeStats.collo_pole;
      document.getElementById('rtLenNC').textContent=nc.len.toLocaleString('id-ID');
      document.getElementById('rtSubNC').textContent=fmtLen(nc.len)+' total';
      document.getElementById('rtSegNC').textContent=nc.seg+' segmen';
      document.getElementById('rtLenCC').textContent=cc.len.toLocaleString('id-ID');
      document.getElementById('rtSubCC').textContent=fmtLen(cc.len)+' total';
      document.getElementById('rtSegCC').textContent=cc.seg+' segmen';
      document.getElementById('rtLenCP').textContent=cp.len.toLocaleString('id-ID');
      document.getElementById('rtSubCP').textContent=fmtLen(cp.len)+' total';
      document.getElementById('rtSegCP').textContent=cp.seg+' segmen';
      tbody.appendChild(trT);

      document.getElementById('footerN').textContent=`Toleransi: ${tol}m | ${p7.unm+p9.unm+te.unm} pole tidak terdeteksi di route manapun`;
      document.getElementById('loadBox').style.display='none';
      document.getElementById('kmzContent').style.display='block';
    } catch(err){
      document.getElementById('loadBox').style.display='none';
      showErr(err.message);
    }
  },30);
}

function onTolChange(v){
  curTol=parseInt(v);
  document.getElementById('tolVal').textContent=v+' m';
  if(kmzData) renderKmz(kmzData,curTol);
}

function resetKmz(){
  kmzData=null; kmzResults=null;
  kmzApp.style.display='none';
  dropZone.style.display='block';
  fileInput.value='';
  document.getElementById('kmzContent').style.display='none';
  document.getElementById('errBox').style.display='none';
}

// ‚îÄ‚îÄ‚îÄ IMPORT KMZ ‚Üí BOQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function importToBoq() {
  if (!kmzResults) return;
  const r = kmzResults;

  // Build new routes array from KMZ
  routes = r.routes.map((rt, i) => {
    const te = (r.tecounts||[])[i]||0;
    return {
      name:       rt.name.replace(/;/g,' ‚Äì '),
      newcable:   r.lengths[i],
      collo:      0,
      collocable: 0,
      hanger:     r.hgcounts[i],
      slack:      0,
      pole7:      r.p7counts[i],
      pole9:      r.p9counts[i],
      isRing:     te > 0,   // aktifkan ring otomatis jika ada TE
      ringTB7:    0,
      ringTB9:    0,
      ringTE:     te,       // TE dari KMZ ‚Üí Collo Pole otomatis
      _fromKmz:   true,
    };
  });

  // Show source badge
  document.getElementById('importSrcName').textContent = document.getElementById('fileName').textContent;
  document.getElementById('importBadge').style.display = 'flex';

  switchTab('boq');
  renderRoutes();
  recalc();
}

function clearImport() {
  routes = [
    { name:'SITE A ‚Äì SITE B', newcable:0, collo:0, collocable:0, hanger:0, slack:0, pole7:0, pole9:0, isRing:false, ringTB7:0, ringTB9:0, ringTE:0 },
    { name:'SITE B ‚Äì SITE C', newcable:0, collo:0, collocable:0, hanger:0, slack:0, pole7:0, pole9:0, isRing:false, ringTB7:0, ringTB9:0, ringTE:0 },
  ];
  document.getElementById('importBadge').style.display='none';
  renderRoutes(); recalc();
}

// ‚îÄ‚îÄ‚îÄ BOQ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ITEMS = [
  { label:'FO Fiberize New Cable',        sub:'‚â§24 Core Services',  price:15525,   cable:true  },
  { label:'FO Fiberize Collo ‚â§24',        sub:'Core Services',      price:7000,    cable:true  },
  { label:'FO Fiberize Collo Cable',       sub:'Tracing & Repair',   price:500,     cable:true  },
  { label:'FO Fiberize Pole 7m, Helical', sub:'New Cable ‚Äî Deadend',price:1500000, cable:false },
  { label:'FO Fiberize Pole 9m, Helical', sub:'New Cable ‚Äî Deadend',price:1700000, cable:false },
  { label:'FO Fiberize Hanger Cable',      sub:'Services',           price:108000,  cable:false },
];

let routes = [
  { name:'SITE A ‚Äì SITE B', newcable:0, collo:0, collocable:0, hanger:0, slack:0, pole7:0, pole9:0, isRing:false, ringTB7:0, ringTB9:0, ringTE:0 },
  { name:'SITE B ‚Äì SITE C', newcable:0, collo:0, collocable:0, hanger:0, slack:0, pole7:0, pole9:0, isRing:false, ringTB7:0, ringTB9:0, ringTE:0 },
];

function calcCable(raw,h,sl){ return (!raw||raw<=0)?0:Math.round(raw*1.1+h*20+sl); }
function computeR(r){
  const cp=(r.isRing?((r.ringTB7||0)+(r.ringTB9||0)+(r.ringTE||0)):0);
  return { nc:calcCable(r.newcable,r.hanger,r.slack), co:calcCable(r.collo,r.hanger,r.slack), cc:calcCable(r.collocable,r.hanger,r.slack), cp };
}

function renderRoutes(){
  const tb=document.getElementById('routeBody');
  tb.innerHTML='';
  routes.forEach((r,i)=>{
    const c=computeR(r);
    const tr=document.createElement('tr');
    if(r._fromKmz) tr.classList.add('from-kmz');
    if(r.isRing)   tr.classList.add('ring-row');
    const kmzTag  = r._fromKmz ? '<span class="badge-k">KMZ</span>' : '';
    const ringTag = r.isRing   ? '<span class="badge-ring">RING</span>' : '';
    const dimCls  = r.isRing   ? 'td-in' : 'td-in-dim';
    tr.innerHTML=`
      <td class="mc">${i+1}</td>
      <td><input class="td-name" value="${r.name}" oninput="routes[${i}].name=this.value;recalc()">${kmzTag}${ringTag}</td>
      <td class="cs1"><input class="td-in" type="text" inputmode="numeric" value="${r.newcable}" placeholder="0"
          oninput="routes[${i}].newcable=pn(this.value);uc(${i});recalc()"></td>
      <td><input class="td-in" type="text" inputmode="numeric" value="${r.collo}" placeholder="0"
          oninput="routes[${i}].collo=pn(this.value);uc(${i});recalc()"></td>
      <td><input class="td-in" type="text" inputmode="numeric" value="${r.collocable}" placeholder="0"
          oninput="routes[${i}].collocable=pn(this.value);uc(${i});recalc()"></td>
      <td><input class="td-in" type="text" inputmode="numeric" value="${r.hanger}" placeholder="0"
          oninput="routes[${i}].hanger=pn(this.value);uc(${i});recalc()"></td>
      <td><input class="td-in" type="text" inputmode="numeric" value="${r.slack}" placeholder="0"
          oninput="routes[${i}].slack=pn(this.value);uc(${i});recalc()"></td>
      <td class="cs2">
        <div class="td-calc" id="c-nc-${i}">${fmt(c.nc)}</div>
        <div class="td-calc-d" id="c-nc-d-${i}">${r.newcable}√ó1.1+${r.hanger}√ó20${r.slack?'+'+r.slack:''}</div>
      </td>
      <td>
        <div class="td-calc" id="c-co-${i}" style="${r.collo===0?'opacity:0.35':''}">${fmt(c.co)}</div>
        <div class="td-calc-d" id="c-co-d-${i}">${r.collo}√ó1.1+${r.hanger}√ó20${r.slack?'+'+r.slack:''}</div>
      </td>
      <td>
        <div class="td-calc" id="c-cc-${i}" style="${r.collocable===0?'opacity:0.35':''}">${fmt(c.cc)}</div>
        <div class="td-calc-d" id="c-cc-d-${i}">${r.collocable}√ó1.1+${r.hanger}√ó20${r.slack?'+'+r.slack:''}</div>
      </td>
      <td class="cs3">
        <input class="td-in" type="text" inputmode="numeric" value="${r.pole7}"
          oninput="routes[${i}].pole7=pn(this.value);recalc()" title="Total TB7 (ring akan dikurangi otomatis)">
        ${r.isRing&&r.ringTB7>0?`<div class="td-calc-d" style="color:#b45309">${r.pole7}-${r.ringTB7}=${Math.max(0,r.pole7-r.ringTB7)} NC</div>`:''}
      </td>
      <td>
        <input class="td-in" type="text" inputmode="numeric" value="${r.pole9}"
          oninput="routes[${i}].pole9=pn(this.value);recalc()" title="Total TB9 (ring akan dikurangi otomatis)">
        ${r.isRing&&r.ringTB9>0?`<div class="td-calc-d" style="color:#b45309">${r.pole9}-${r.ringTB9}=${Math.max(0,r.pole9-r.ringTB9)} NC</div>`:''}
      </td>
      <td class="cs4" style="text-align:center">
        <input type="checkbox" class="ring-chk" title="Aktifkan Ring Logic" ${r.isRing?'checked':''}
          onchange="routes[${i}].isRing=this.checked;renderRoutes();recalc()">
      </td>
      <td><input class="${dimCls}" type="text" inputmode="numeric" value="${r.ringTB7||0}" placeholder="0"
          oninput="routes[${i}].ringTB7=pn(this.value);uc(${i});recalc()" title="TB7 dilewati 2x"></td>
      <td><input class="${dimCls}" type="text" inputmode="numeric" value="${r.ringTB9||0}" placeholder="0"
          oninput="routes[${i}].ringTB9=pn(this.value);uc(${i});recalc()" title="TB9 dilewati 2x"></td>
      <td>
        <input class="${dimCls}" type="text" inputmode="numeric" value="${r.ringTE||0}" placeholder="0"
          oninput="routes[${i}].ringTE=pn(this.value);uc(${i});recalc()" title="TE (Existing Pole) ‚Üí Collo Pole">
        ${r._fromKmz&&(r.ringTE||0)>0?`<div class="td-calc-d" style="color:#b45309">dari KMZ</div>`:''}
      </td>
      <td>
        <div class="td-calc-ring" id="c-cp-${i}" style="${!r.isRing||c.cp===0?'opacity:0.3':''}">${c.cp}</div>
        <div class="td-calc-d">‚Üí masuk Collo ‚â§24</div>
      </td>
      <td class="c"><button class="btn-del" onclick="delRoute(${i})">‚úï</button></td>`;
    tb.appendChild(tr);
  });
  document.getElementById('infoRoutes').textContent=routes.length+' route';
}

function uc(i){
  const r=routes[i], c=computeR(r), ss=r.slack?'+'+r.slack:'';
  const set=(id,v,op)=>{ const el=document.getElementById(id); if(el){el.textContent=v; if(op!==undefined)el.style.opacity=op;} };
  set(`c-nc-${i}`,fmt(c.nc));
  set(`c-nc-d-${i}`,`${r.newcable}√ó1.1+${r.hanger}√ó20${ss}`);
  set(`c-co-${i}`,fmt(c.co),r.collo===0?'0.35':'1');
  set(`c-co-d-${i}`,`${r.collo}√ó1.1+${r.hanger}√ó20${ss}`);
  set(`c-cc-${i}`,fmt(c.cc),r.collocable===0?'0.35':'1');
  set(`c-cc-d-${i}`,`${r.collocable}√ó1.1+${r.hanger}√ó20${ss}`);
  set(`c-cp-${i}`,c.cp,(!r.isRing||c.cp===0)?'0.3':'1');
}

function addRoute(){
  const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ', n=routes.length;
  routes.push({name:`SITE ${L[n]} ‚Äì SITE ${L[n+1]}`,newcable:0,collo:0,collocable:0,hanger:0,slack:0,pole7:0,pole9:0,isRing:false,ringTB7:0,ringTB9:0,ringTE:0});
  renderRoutes(); recalc();
}
function delRoute(i){
  if(routes.length<=1) return alert('Minimal harus ada 1 route.');
  routes.splice(i,1); renderRoutes(); recalc();
}

function recalc(){
  const vp=pn(document.getElementById('vatPct').value)/100||0;
  document.getElementById('vatLbl').textContent=(vp*100).toFixed(0)+'%';
  document.getElementById('vatChip').textContent=(vp*100).toFixed(0);

  const keys=['newcable','collo','collocable','pole7','pole9','hanger'];
  const vpR=routes.map(r=>{
    const c=computeR(r);
    const rTB7=r.isRing?r.ringTB7||0:0, rTB9=r.isRing?r.ringTB9||0:0;
    return {newcable:c.nc, collo:c.co+c.cp, collocable:c.cc, pole7:Math.max(0,r.pole7-rTB7), pole9:Math.max(0,r.pole9-rTB9), hanger:r.hanger};
  });

  const tb=document.getElementById('boqBody'); tb.innerHTML='';
  let gSub=0,gVol=0;

  ITEMS.forEach((item,idx)=>{
    const key=keys[idx];
    const vols=vpR.map(v=>v[key]);
    const tv=vols.reduce((a,b)=>a+b,0), ta=tv*item.price;
    gSub+=ta; gVol+=tv;
    const ca=vols[0]??0,cb=vols[1]??0;
    const ec=vols.slice(2).length, es=vols.slice(2).reduce((a,b)=>a+b,0);
    const badge=item.cable?'<span class="badge-f">+formula</span>':'';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="mc">${idx+1}</td>
      <td><div class="it-desc">${item.label}${badge}<small>${item.sub}</small></div></td>
      <td class="r"><input class="td-in" type="text" inputmode="numeric" value="${item.price}" style="min-width:100px"
          oninput="ITEMS[${idx}].price=pn(this.value);recalc()"></td>
      <td class="r computed">${fmt(ca)}</td>
      <td class="r computed">${fmt(cb)}${ec>0?`<br><span style="font-size:0.67rem;color:var(--muted)">+${ec} lain: ${fmt(es)}</span>`:''}</td>
      <td class="r"><strong>${fmt(tv)}</strong></td>
      <td class="r computed-t">${fmtRp(ta)}</td>`;
    tb.appendChild(tr);
  });

  const vat=gSub*vp, tot=gSub+vat;
  const mkRow=(cls,lbl,vol,amt)=>{
    const tr=document.createElement('tr'); tr.className=cls;
    tr.innerHTML=`<td colspan="5" style="text-align:right;font-size:0.8rem">${lbl}</td><td class="r">${vol}</td><td class="r">${amt}</td>`;
    tb.appendChild(tr);
  };
  mkRow('row-sub','SUBTOTAL',fmt(gVol),fmtRp(gSub));
  mkRow('row-vat',`VAT ${(vp*100).toFixed(0)}%`,'‚Äî',fmtRp(vat));
  mkRow('row-tot','TOTAL AKHIR','‚Äî',fmtRp(tot));

  document.getElementById('sumSub').textContent=fmtS(gSub);   document.getElementById('sumSubF').textContent=fmtRp(gSub);
  document.getElementById('sumVat').textContent=fmtS(vat);    document.getElementById('sumVatF').textContent=fmtRp(vat);
  document.getElementById('sumTot').textContent=fmtS(tot);    document.getElementById('sumTotF').textContent=fmtRp(tot);
  document.getElementById('sumVol').textContent=fmt(gVol);
  document.getElementById('colA').textContent=routes[0]?.name||'Route 1';
  document.getElementById('colB').textContent=routes[1]?.name||'Route 2';
}

function pn(v){ const n=parseFloat(String(v).replace(/[^0-9.]/g,'')); return isNaN(n)?0:n; }
function fmt(n){ return Math.round(n).toLocaleString('id-ID'); }
function fmtRp(n){ return 'Rp '+Math.round(n).toLocaleString('id-ID'); }
function fmtS(n){
  if(n>=1e9) return 'Rp '+(n/1e9).toFixed(2)+' M';
  if(n>=1e6) return 'Rp '+(n/1e6).toFixed(2)+' jt';
  return 'Rp '+Math.round(n).toLocaleString('id-ID');
}

function exportCSV(){
  const name=document.getElementById('projName').value;
  const vp=pn(document.getElementById('vatPct').value)/100||0;
  const keys=['newcable','collo','collocable','pole7','pole9','hanger'];
  const vpR=routes.map(r=>{
    const c=computeR(r);
    const rTB7=r.isRing?r.ringTB7||0:0, rTB9=r.isRing?r.ringTB9||0:0;
    return {newcable:c.nc, collo:c.co+c.cp, collocable:c.cc, pole7:Math.max(0,r.pole7-rTB7), pole9:Math.max(0,r.pole9-rTB9), hanger:r.hanger};
  });

  let csv=`Pekerjaan;${name}\nVAT;${(vp*100).toFixed(0)}%\n\n`;
  csv+=`No;Uraian Pekerjaan;Unit Price;`;
  routes.forEach(r=>csv+=r.name+';');
  csv+=`Total Volume;Total Amount\n`;

  let gs=0;
  ITEMS.forEach((item,idx)=>{
    const vols=vpR.map(v=>v[keys[idx]]);
    const tv=vols.reduce((a,b)=>a+b,0),ta=tv*item.price; gs+=ta;
    csv+=`${idx+1};${item.label} ${item.sub};${item.price};`;
    vols.forEach(v=>csv+=Math.round(v)+';');
    csv+=`${Math.round(tv)};${Math.round(ta)}\n`;
  });
  const vat=gs*vp;
  csv+=`;;Subtotal;;;${Math.round(gs)}\n;;VAT ${(vp*100).toFixed(0)}%;;;${Math.round(vat)}\n;;TOTAL;;;${Math.round(gs+vat)}\n`;
  csv+=`\n\nDETAIL INPUT\nRoute;Ring;TB7 Ring;TB9 Ring;TE Ring;Collo Pole;New Cable Raw;Collo Raw;Collo Cable Raw;Hanger;Slack;New Cable Akhir;Collo Akhir;Collo Cable Akhir;Pole 7;Pole 9\n`;
  routes.forEach(r=>{ const c=computeR(r); csv+=`${r.name};${r.isRing?'Ya':'Tidak'};${r.ringTB7||0};${r.ringTB9||0};${r.ringTE||0};${c.cp};${r.newcable};${r.collo};${r.collocable};${r.hanger};${r.slack};${c.nc};${c.co};${c.cc};${r.pole7};${r.pole9}\n`; });

  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`BOQ_${name.replace(/\s+/g,'_')}.csv`; a.click();
}

renderRoutes();
recalc();
</script>
</body>
</html>
